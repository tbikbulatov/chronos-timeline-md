<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chronos Timeline Markdown Playground</title>
    <meta
      name="description"
      content="Generate interactive timelines from simple, shareable text"
    />
    <!-- Open Graph / Social meta -->
    <meta property="og:title" content="Chronos Timeline Markdown Playground" />
    <meta
      property="og:description"
      content="Generate interactive timelines from simple, shareable text"
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://clairefro.github.io/chronos-timeline-md/"
    />
    <meta
      property="og:image"
      content="https://raw.githubusercontent.com/clairefro/chronos-timeline-md/main/docs/ex-groups.png"
    />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Chronos Timeline Markdown Playground" />
    <meta
      name="twitter:description"
      content="Generate interactive timelines from simple, shareable text"
    />
    <meta
      name="twitter:image"
      content="https://raw.githubusercontent.com/clairefro/chronos-timeline-md/main/docs/ex-groups.png"
    />
    <!-- Icons and PWA manifest -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="msapplication-TileColor" content="#2b5797" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />

    <!-- Include highlight.js for syntax highlighting -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
      /* CSS Variables for Light/Dark Theme */
      :root {
        --bg-primary: #f8f9fa;
        --bg-secondary: white;
        --bg-tertiary: #f6f8fa;
        --text-primary: #24292e;
        --text-secondary: #586069;
        --text-muted: #959da5;
        --border-primary: #e1e4e8;
        --border-secondary: #d1d5da;
        --header-bg: #24292e;
        --header-text: white;
        --accent-color: #0366d6;
        --accent-hover: #005cc5;
        --error-bg: #fff5f5;
        --error-border: #fed7d7;
        --error-text: #742a2a;
        --loading-bg: #fafbfc;
        --highlight-bg: rgba(3, 102, 214, 0.3);
        --focus-shadow: rgba(3, 102, 214, 0.1);

        /* Syntax highlighting colors */
        --syntax-event: #22863a;
        --syntax-period: #6f42c1;
        --syntax-point: #005cc5;
        --syntax-marker: #e36209;
        --syntax-date-bracket: #032f62;
        --syntax-date: #005cc5;
        --syntax-range: #d73a49;
        --syntax-color: #e36209;
        --syntax-group: #6f42c1;
        --syntax-comment: #6a737d;
        --syntax-flag: #735c0f;
      }

      [data-theme="dark"] {
        --bg-primary: #0d1117;
        --bg-secondary: #161b22;
        --bg-tertiary: #21262d;
        --text-primary: #c9d1d9;
        --text-secondary: #8b949e;
        --text-muted: #7d8590;
        --border-primary: #30363d;
        --border-secondary: #21262d;
        --header-bg: #010409;
        --header-text: #c9d1d9;
        --accent-color: #58a6ff;
        --accent-hover: #1f6feb;
        --error-bg: #1a1e1a;
        --error-border: #2d1b1b;
        --error-text: #f85149;
        --loading-bg: #0d1117;
        --highlight-bg: rgba(88, 166, 255, 0.3);
        --focus-shadow: rgba(88, 166, 255, 0.1);

        /* Dark mode syntax highlighting colors */
        --syntax-event: #3fb950;
        --syntax-period: #a855f7;
        --syntax-point: #58a6ff;
        --syntax-marker: #fb8500;
        --syntax-date-bracket: #79c0ff;
        --syntax-date: #58a6ff;
        --syntax-range: #f85149;
        --syntax-color: #fb8500;
        --syntax-group: #a855f7;
        --syntax-comment: #8b949e;
        --syntax-flag: #d29922;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        height: 100vh;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
      }

      a {
        color: orange;
      }

      .header {
        background: var(--header-bg);
        color: var(--header-text);
        padding: 1rem 2rem;
        border-bottom: 1px solid var(--border-primary);
        position: relative;
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .header p {
        color: var(--text-muted);
        margin-top: 0.5rem;
      }

      .header-links {
        position: absolute;
        top: 1rem;
        right: 2rem;
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .header-version {
        color: var(--text-muted);
        font-size: 0.8rem;
        padding: 0.2rem 0.4rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }

      .header-subtitle-section {
        display: inline-block;
      }

      .theme-toggle {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .theme-toggle:hover {
        color: var(--header-text);
        background: rgba(255, 255, 255, 0.1);
      }

      .header-link {
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .header-link:hover {
        color: var(--header-text);
        background: rgba(255, 255, 255, 0.1);
      }

      .header-link svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      .container {
        display: flex;
        height: calc(100vh - 80px);
      }

      .input-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-secondary);
        min-width: 200px;
      }

      .output-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-secondary);
        min-width: 200px;
      }

      .divider {
        width: 8px;
        background: var(--bg-tertiary);
        border-left: 1px solid var(--border-primary);
        border-right: 1px solid var(--border-primary);
        cursor: col-resize;
        position: relative;
        transition: background-color 0.2s;
      }

      .divider:hover {
        background: var(--border-primary);
      }

      .divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 3px;
        height: 20px;
        background: var(--text-secondary);
        border-radius: 1px;
        box-shadow:
          -2px 0 0 var(--text-secondary),
          2px 0 0 var(--text-secondary);
      }

      .panel-header {
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-primary);
        padding: 0.75rem 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .chronos-error-message-container {
        color: var(--error-text) !important;
        background-color: var(--error-bg);
      }

      .input-area {
        flex: 1;
        padding: 1rem;
        position: relative;
      }

      .editor-container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      #markdown-input {
        width: 100%;
        height: 100%;
        border: none;
        resize: none;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 14px;
        line-height: 1.5;
        background: transparent;
        padding: 1rem;
        border-radius: 6px;
        border: 1px solid var(--border-primary);
        outline: none;
        position: relative;
        z-index: 2;
        color: transparent;
        caret-color: var(--text-primary);
      }

      #markdown-input::selection {
        background: var(--highlight-bg);
      }

      #markdown-input:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px var(--focus-shadow);
      }

      #highlight-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 1rem;
        pointer-events: none;
        z-index: 1;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow: hidden;
        background: var(--loading-bg);
        border-radius: 6px;
        border: 1px solid var(--border-primary);
      }

      /* Chronos syntax highlighting styles - these will be replaced by library CSS */
      #highlight-backdrop .hljs-section {
        color: var(--syntax-event);
        font-weight: 600;
      } /* Events (-) */
      #highlight-backdrop .hljs-keyword {
        color: var(--syntax-period);
        font-weight: 600;
      } /* Periods (@) */
      #highlight-backdrop .hljs-attribute {
        color: var(--syntax-point);
      } /* Points (*) */
      #highlight-backdrop .hljs-built_in {
        color: var(--syntax-marker);
        font-weight: 600;
      } /* Markers (=) */
      #highlight-backdrop .hljs-string {
        color: var(--syntax-date-bracket);
        font-weight: 500;
      } /* Date brackets */
      #highlight-backdrop .hljs-number {
        color: var(--syntax-date);
        font-weight: 600;
      } /* Dates */
      #highlight-backdrop .hljs-operator {
        color: var(--syntax-range);
        font-weight: bold;
      } /* Range ~ */
      #highlight-backdrop .hljs-literal {
        color: var(--syntax-color);
        font-weight: 600;
      } /* Colors */
      #highlight-backdrop .hljs-title {
        color: var(--syntax-group);
        font-weight: 500;
      } /* Groups */
      #highlight-backdrop .hljs-comment {
        color: var(--syntax-comment);
        opacity: 0.8;
      } /* Comments */
      #highlight-backdrop .hljs-meta {
        color: var(--syntax-flag);
        font-weight: 600;
      } /* Flags */

      /* Hover effects for highlighting */
      #highlight-backdrop .hljs-literal:hover,
      #highlight-backdrop .hljs-number:hover {
        background-color: rgba(255, 212, 0, 0.15);
        border-radius: 2px;
      }

      #highlight-backdrop .hljs-title:hover {
        background-color: rgba(168, 85, 247, 0.1);
        border-radius: 2px;
      }

      .output-area {
        padding: 1rem;
        overflow: auto;
      }

      #timeline-container {
        width: 100%;
        min-height: 200px;
        border: 1px solid var(--border-primary);
        background: var(--bg-secondary);
      }

      .controls {
        padding: 1rem;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .control-group label {
        font-size: 14px;
        color: var(--text-secondary);
      }

      .control-group label:has(input[type="checkbox"]) {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        cursor: pointer;
      }

      /* Fallback for browsers that don't support :has() */
      .control-group label input[type="checkbox"] {
        margin-right: 0.3rem;
      }

      /* Ensure parent label displays as flex when containing checkbox */
      label:has(input[type="checkbox"]),
      label input[type="checkbox"] {
        vertical-align: middle;
      }

      label:has(input[type="checkbox"]) {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .control-group select,
      .control-group input {
        padding: 0.4rem 0.6rem;
        border: 1px solid var(--border-primary);
        border-radius: 4px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .control-group select optgroup {
        font-weight: 600;
        color: var(--text-secondary);
        background: var(--bg-tertiary);
      }

      .control-group select option {
        font-weight: normal;
        color: var(--text-primary);
        background: var(--bg-secondary);
        padding: 0.2rem 0.5rem;
      }

      .options-toggle-container {
        display: flex;
        align-items: center;
      }

      .options-toggle {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid var(--border-primary);
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .options-toggle-icon {
        transition: transform 0.2s;
        display: flex;
        align-items: center;
      }

      .options-toggle.expanded .options-toggle-icon {
        transform: rotate(180deg);
      }

      .options-menu {
        background: var(--bg-tertiary);
        padding: 1rem 0;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .controls {
        position: relative;
        border-radius: 6px 6px 0 0;
      }

      .export-controls {
        padding: 1rem;
        background: var(--bg-tertiary);
        border-top: 1px solid var(--border-primary);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .export-options {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .export-option-label {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 14px;
        color: var(--text-secondary);
        cursor: pointer;
        white-space: nowrap;
      }

      .export-option-label input[type="checkbox"] {
        margin: 0;
      }

      .export-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .instructions-box {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        padding: 1rem;
        margin: 1rem;
        margin-top: 0;
      }

      .instructions-box h3 {
        margin: 0 0 0.5rem 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .instructions-box ul {
        margin: 0;
        padding-left: 1.2rem;
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .instructions-box li {
        margin-bottom: 0.25rem;
      }

      .export-btn {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .export-btn:hover {
        background: var(--accent-hover);
      }

      .export-btn:disabled {
        background: var(--text-secondary);
        cursor: not-allowed;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        height: 200px;
        color: var(--text-secondary);
        gap: 1rem;
        animation: pulse 2s infinite;
      }

      .loading::before {
        content: "üç†";
        font-size: 2rem;
        animation: spin 3s linear infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .error-message {
        padding: 2rem;
        background: var(--error-bg);
        border: 1px solid var(--error-border);
        border-radius: 8px;
        margin: 1rem;
        color: var(--error-text);
        max-width: 600px;
        margin: 1rem auto;
      }

      .error-message h3 {
        color: var(--error-text);
        margin-bottom: 1rem;
        font-size: 1.2rem;
      }

      .error-message ul {
        margin: 1rem 0;
        padding-left: 1.5rem;
      }

      .error-message li {
        margin: 0.5rem 0;
      }

      .error-message details {
        margin-top: 1rem;
        padding: 0.5rem;
        background: var(--bg-tertiary);
        border-radius: 4px;
      }

      .error-message summary {
        cursor: pointer;
        font-weight: 500;
      }

      .error-message code {
        display: block;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: 3px;
        word-break: break-all;
      }

      .env-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #28a745;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
      }

      .env-indicator.local {
        background: #17a2b8;
      }

      /* Tablet and Mobile Responsive Design */
      @media (max-width: 1024px) {
        .header {
          padding: 1rem;
          text-align: center;
          position: relative;
        }

        .header h1 {
          font-size: 1.25rem;
          margin-bottom: 0.5rem;
        }

        .header p {
          font-size: 0.875rem;
        }

        .header-links {
          position: static;
          margin-top: 1rem;
          justify-content: center;
          flex-wrap: wrap;
        }

        .header-subtitle-section {
          display: block;
        }

        .header-version {
          order: -1;
          margin-bottom: 0.5rem;
        }

        .container {
          flex-direction: column;
          height: auto;
          min-height: calc(100vh - 120px);
        }

        .input-panel {
          flex: none;
          height: 50vh;
          min-height: 300px;
          border-bottom: 1px solid var(--border-primary);
          border-right: none;
        }

        .output-panel {
          flex: 1;
          min-height: 50vh;
        }

        /* Hide horizontal divider on mobile */
        .divider {
          display: none;
        }

        /* Add vertical divider for mobile */
        .input-panel::after {
          content: "";
          position: absolute;
          bottom: -4px;
          left: 0;
          right: 0;
          height: 8px;
          background: var(--bg-tertiary);
          border-top: 1px solid var(--border-primary);
          border-bottom: 1px solid var(--border-primary);
          cursor: row-resize;
          z-index: 10;
        }

        /* Add drag indicator lines to mobile divider */
        .input-panel::before {
          content: "";
          position: absolute;
          bottom: -1px;
          left: 50%;
          transform: translateX(-50%);
          width: 20px;
          height: 4px;
          background: var(--text-secondary);
          border-radius: 1px;
          box-shadow:
            0 -2px 0 var(--text-secondary),
            0 2px 0 var(--text-secondary);
          z-index: 11;
          pointer-events: none;
        }

        .input-panel {
          position: relative;
        }

        /* Mobile-specific form adjustments */
        .controls {
          padding: 0.75rem;
          flex-wrap: wrap;
          gap: 0.5rem;
        }

        .control-group {
          flex: 1;
          min-width: 0;
          flex-shrink: 1;
        }

        .options-toggle-container {
          min-width: 100%;
          flex: 0 0 100%;
          margin-top: 0.25rem;
        }

        .control-group label {
          font-size: 12px;
        }

        .control-group select,
        .control-group input {
          font-size: 12px;
          padding: 0.25rem 0.4rem;
          width: 100%;
        }

        .options-toggle {
          font-size: 12px;
          padding: 0.4rem 0.6rem;
        }

        .options-menu {
          padding: 0.75rem;
          gap: 0.5rem;
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          align-items: center;
        }

        .options-menu .control-group {
          min-width: auto;
          flex: none;
        }

        .export-controls {
          padding: 0.75rem;
          flex-direction: column;
          gap: 0.75rem;
          align-items: stretch;
        }

        .export-buttons {
          flex-direction: column;
          gap: 0.75rem;
        }

        .export-btn {
          width: 100%;
          padding: 0.75rem;
          font-size: 14px;
        }

        .instructions-box {
          margin: 0.75rem;
          padding: 0.75rem;
        }

        .instructions-box h3 {
          font-size: 1rem;
        }

        /* Textarea adjustments for mobile */
        .textarea-container textarea {
          font-size: 14px;
          line-height: 1.4;
        }

        /* Error message responsive */
        .error-message {
          margin: 0.75rem;
          padding: 1rem;
        }

        .error-message h3 {
          font-size: 1rem;
        }

        .error-message ul {
          padding-left: 1rem;
        }

        /* Environment indicator mobile position */
        .env-indicator {
          top: 5px;
          right: 5px;
          font-size: 10px;
          padding: 0.2rem 0.4rem;
        }
      }

      /* Small mobile devices */
      @media (max-width: 480px) {
        .header {
          padding: 0.75rem;
        }

        .header h1 {
          font-size: 1.1rem;
        }

        .header-links {
          gap: 0.5rem;
        }

        .header-link {
          font-size: 0.8rem;
          padding: 0.2rem 0.4rem;
        }

        .input-panel {
          height: 45vh;
          min-height: 250px;
        }

        .controls {
          padding: 0.5rem;
        }

        .control-group {
          min-width: 100%;
        }

        .options-toggle {
          font-size: 11px;
          padding: 0.3rem 0.5rem;
        }

        .options-menu {
          padding: 0.5rem;
        }

        .textarea-container textarea {
          font-size: 13px;
          padding: 0.5rem;
        }

        .instructions-box {
          margin: 0.5rem;
          padding: 0.5rem;
        }

        .instructions-box h3 {
          font-size: 0.9rem;
        }

        .instructions-box ul {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="env-indicator" class="env-indicator">Loading...</div>

    <div class="header">
      <div class="header-links">
        <a
          href="https://github.com/clairefro/chronos-timeline-md"
          target="_blank"
          rel="noopener noreferrer"
          class="header-link"
        >
          <svg viewBox="0 0 16 16">
            <path
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
            />
          </svg>
          GitHub
        </a>
        <a
          href="https://www.npmjs.com/package/chronos-timeline-md"
          target="_blank"
          rel="noopener noreferrer"
          class="header-link"
        >
          <svg viewBox="0 0 16 16">
            <path
              d="M0 10h16v2H0v-2zm1-1h14V7H1v2zm1-3h12V4H2v2zm1-3h10V1H3v2z"
            />
          </svg>
          npm
        </a>
        <button id="theme-toggle" class="theme-toggle" title="Toggle dark mode">
          <span id="theme-icon">üåô</span>
        </button>
        <span id="header-version" class="header-version">Loading...</span>
      </div>
      <h1>Chronos Timeline Markdown Playground</h1>
      <div class="header-subtitle-section">
        <p>Generate interactive timelines from simple, shareable text</p>
        <p></p>
      </div>

      <div class="header-subtitle-section">
        <p>
          <a
            href="https://github.com/clairefro/chronos-timeline-md/blob/main/CHRONOS_SYNTAX_GUIDE.md"
            target="_blank"
            rel="nofollow noreferrer"
            >Syntax</a
          >
          |
          <a
            href="https://github.com/clairefro/chronos-timeline-md/"
            target="_blank"
            rel="nofollow noreferrer"
            >Developers</a
          >
          |
          <a
            href="https://obsidian.md/plugins?search=chronos+timeline"
            target="_blank"
            rel="nofollow noreferrer"
            >Obsidian Plugin</a
          >
        </p>
        <p></p>
      </div>
    </div>

    <div class="container">
      <div class="input-panel">
        <div class="panel-header">Edit Markdown</div>
        <div class="controls">
          <div class="control-group">
            <select id="examples-select">
              <option value="">Show Example...</option>
            </select>
          </div>

          <div class="control-group">
            <select id="snippets-select">
              <option value="">Insert Snippet...</option>
            </select>
          </div>

          <div class="options-toggle-container">
            <button id="options-toggle" class="options-toggle" type="button">
              <span>Options</span>
              <span class="options-toggle-icon">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path
                    d="M3 4.5L6 7.5L9 4.5"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </span>
            </button>
          </div>

          <div id="options-menu" class="options-menu" style="display: none">
            <div class="control-group">
              <label for="locale-select">Locale:</label>
              <select id="locale-select">
                <option value="en" selected>English</option>
                <option value="de">Deutsch (German)</option>
                <option value="es">Espa√±ol (Spanish)</option>
                <option value="fr">Fran√ßais (French)</option>
                <option value="it">Italiano (Italian)</option>
                <option value="nl">Nederlands (Dutch)</option>
                <option value="pl">Polski (Polish)</option>
                <option value="ru">–†—É—Å—Å–∫–∏–π (Russian)</option>
                <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (Ukrainian)</option>
                <option value="ja">Êó•Êú¨Ë™û (Japanese)</option>
              </select>
            </div>
            <div class="control-group">
              <label for="round-ranges">
                <input type="checkbox" id="round-ranges" /> Round Ranges
              </label>
            </div>
            <div class="control-group">
              <label for="use-utc">
                <input type="checkbox" id="use-utc" checked /> Use UTC Time
                (recommended)
              </label>
            </div>
            <div class="control-group">
              <label for="alignment">Alignment:</label>
              <select id="alignment">
                <option value="left">Left</option>
                <option value="center">Center</option>
                <option value="right">Right</option>
              </select>
            </div>
          </div>
        </div>
        <div class="input-area">
          <div class="editor-container">
            <textarea
              id="markdown-input"
              placeholder="Enter Chronos markdown here"
            ></textarea>
            <div id="highlight-backdrop"></div>
          </div>
        </div>
      </div>

      <div class="divider" id="divider"></div>

      <div class="output-panel">
        <div class="panel-header">Timeline</div>
        <div class="output-area">
          <div id="timeline-container">
            <div class="loading">
              Enter markdown to see a timeline. See
              <a
                href="https://github.com/clairefro/chronos-timeline-md/blob/main/CHRONOS_SYNTAX_GUIDE.md"
                target="_blank"
                rel="noopener noreferrer"
                >docs</a
              >
              for syntax.
            </div>
          </div>
        </div>
        <div class="instructions-box">
          <h3>Interacting with the Timeline</h3>
          <ul>
            <li>Click and drag the timeline left and right</li>
            <li>Scroll to zoom</li>
            <li>
              Lost? Click the crosshairs icon in lower right to re-fit items
            </li>
            <li>Try the examples to get started</li>
          </ul>
        </div>
        <div class="export-controls">
          <div class="export-buttons">
            <button id="export-png-btn" class="export-btn" disabled>
              Export as PNG
            </button>
            <button id="share-link-btn" class="export-btn">
              Copy Shareable Link
            </button>
            <span
              id="export-status"
              style="color: var(--text-secondary); font-size: 14px"
            ></span>
          </div>
          <div class="export-options">
            <label for="transparent-bg-checkbox" class="export-option-label">
              <input type="checkbox" id="transparent-bg-checkbox" />
              Transparent background
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Smart Loading Script -->
    <script>
      // Function to update syntax highlighting
      function updateSyntaxHighlighting() {
        const textarea = document.getElementById("markdown-input");
        const backdrop = document.getElementById("highlight-backdrop");

        if (textarea && backdrop) {
          const content = textarea.value;
          try {
            const highlighted = hljs.highlight(content, {
              language: "chronos",
            }).value;
            backdrop.innerHTML = highlighted;
          } catch (error) {
            console.warn("Syntax highlighting failed:", error);
            backdrop.innerHTML = textarea.value;
          }
        }
      }

      // Function to sync scroll between textarea and backdrop
      function syncScroll() {
        const textarea = document.getElementById("markdown-input");
        const backdrop = document.getElementById("highlight-backdrop");

        if (textarea && backdrop) {
          backdrop.scrollTop = textarea.scrollTop;
          backdrop.scrollLeft = textarea.scrollLeft;
        }
      }

      // Theme toggle functionality
      function initializeTheme() {
        const themeToggle = document.getElementById("theme-toggle");
        const themeIcon = document.getElementById("theme-icon");
        const body = document.body;

        // Check for saved theme preference or default to light mode
        const savedTheme = localStorage.getItem("chronos-theme") || "light";

        function applyTheme(theme) {
          if (theme === "dark") {
            body.setAttribute("data-theme", "dark");
            themeIcon.textContent = "‚òÄÔ∏è";
            themeToggle.title = "Switch to light mode";
          } else {
            body.setAttribute("data-theme", "light");
            themeIcon.textContent = "üåô";
            themeToggle.title = "Switch to dark mode";
          }
        }

        // Apply saved theme
        applyTheme(savedTheme);

        // Theme toggle event listener
        themeToggle.addEventListener("click", () => {
          const currentTheme = body.getAttribute("data-theme");
          const newTheme = currentTheme === "dark" ? "light" : "dark";

          applyTheme(newTheme);
          localStorage.setItem("chronos-theme", newTheme);
        });
      }

      // Initialize theme on page load
      initializeTheme();
      // Detect environment and load appropriate Chronos library
      async function loadChronos() {
        const isGitHubPages = window.location.hostname.includes("github.io");
        const isLocalhost =
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1";

        // Update environment indicator
        const envIndicator = document.getElementById("env-indicator");

        try {
          let chronosLibrary;

          if (isLocalhost) {
            // Local development - try ES modules first, fallback to IIFE
            envIndicator.textContent = "Local Dev";
            envIndicator.className = "env-indicator local";

            try {
              console.log("Loading local ES modules...");
              chronosLibrary = await import("./dist/index.js");
            } catch (esError) {
              console.log("ES modules failed, trying local IIFE...");
              await loadScript("./dist/iife-entry.global.js");
              chronosLibrary = window.ChronosTimeline;
            }
          } else if (isGitHubPages) {
            // GitHub Pages - use enhanced CDN loading
            envIndicator.style.display = "none";
            console.log("GitHub Pages detected - loading from CDN...");

            updateLoadingStatus(
              "Updating to latest Chronos Timeline library...",
            );
            chronosLibrary = await loadChronosLibrary();
          } else {
            // Other hosting - try CDN first with enhanced loading, then fallback to local
            envIndicator.textContent = "Production";

            try {
              updateLoadingStatus(
                "Loading Chronos Timeline library from CDN...",
              );
              chronosLibrary = await loadChronosLibrary();
            } catch (cdnError) {
              console.log("All CDN sources failed, trying local fallback...");
              updateLoadingStatus("CDN failed, trying local files...");

              try {
                await loadScript("./dist/iife-entry.global.js", 2, 1000);
                chronosLibrary = window.ChronosTimeline;

                if (!chronosLibrary) {
                  throw new Error(
                    "Local file loaded but ChronosTimeline not found",
                  );
                }
                console.log("Local fallback successful!");
              } catch (localError) {
                throw new Error(
                  `Both CDN and local loading failed. CDN: ${cdnError.message}, Local: ${localError.message}`,
                );
              }
            }
          }

          if (!chronosLibrary) {
            throw new Error("Failed to load Chronos library");
          }

          // Initialize the app
          const {
            ChronosTimeline,
            parseChronos,
            renderChronos,
            attachChronosStyles,
            ui,
          } = chronosLibrary;

          // Use library's syntax highlighting if available
          if (
            ui &&
            ui.registerChronosLanguage &&
            ui.injectChronosHighlightCSS
          ) {
            console.log("Using library's syntax highlighting...");

            // Register the language and inject CSS from library
            ui.registerChronosLanguage(hljs);
            ui.injectChronosHighlightCSS();

            // Update the highlighting function to use library's version
            const originalUpdateSyntaxHighlighting = updateSyntaxHighlighting;
            updateSyntaxHighlighting = function () {
              const textarea = document.getElementById("markdown-input");
              const backdrop = document.getElementById("highlight-backdrop");

              if (textarea && backdrop && ui.highlightChronosText) {
                const content = textarea.value;
                try {
                  const highlighted = ui.highlightChronosText(content, hljs);
                  backdrop.innerHTML = highlighted;
                } catch (error) {
                  console.warn(
                    "Library syntax highlighting failed, using fallback:",
                    error,
                  );
                  originalUpdateSyntaxHighlighting();
                }
              } else {
                originalUpdateSyntaxHighlighting();
              }
            };
          } else {
            console.log(
              "Library syntax highlighting not available, using built-in fallback...",
            );
          }
          initializeApp({
            ChronosTimeline,
            parseChronos,
            renderChronos,
            attachChronosStyles,
          }); // Hide environment indicator after successful load
          setTimeout(() => {
            envIndicator.style.display = "none";
          }, 2000);
        } catch (error) {
          console.error("Failed to load Chronos library:", error);
          envIndicator.textContent = "Error";
          envIndicator.style.background = "#dc3545";

          const errorMessage = `
            <div class="error-message">
              <h3>üö´ Failed to Load Chronos Timeline</h3>
              <p><strong>Don't worry!</strong> This usually happens when:</p>
              <ul>
                <li>Network connection is slow or unstable</li>
                <li>A new version was just released (CDN needs time to update)</li>
                <li>Browser cache is causing conflicts</li>
              </ul>
              <p><strong>Quick fixes:</strong></p>
              <ul>
                <li><button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">Refresh this page</button></li>
                <li>Clear browser cache and try again</li>
                <li>‚è±Wait a few minutes and retry (new releases take time to propagate)</li>
              </ul>
              <details>
                <summary>Technical details</summary>
                <code style="font-size: 12px; color: #666;">${error.message}</code>
              </details>
            </div>
          `;

          updateLoadingStatus(errorMessage, true);
        }
      }

      // Helper function to load scripts dynamically with retry logic
      function loadScript(src, retries = 3, delay = 1000) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = src;

          script.onload = () => {
            console.log(`Successfully loaded: ${src}`);
            resolve();
          };

          script.onerror = (error) => {
            console.warn(`Failed to load: ${src}`);
            document.head.removeChild(script);

            if (retries > 0) {
              console.log(
                `Retrying in ${delay}ms... (${retries} attempts left)`,
              );
              setTimeout(() => {
                loadScript(src, retries - 1, delay * 2)
                  .then(resolve)
                  .catch(reject);
              }, delay);
            } else {
              reject(
                new Error(
                  `Failed to load script after multiple attempts: ${src}`,
                ),
              );
            }
          };

          document.head.appendChild(script);
        });
      }

      // Enhanced script loader with multiple CDN fallbacks
      async function loadChronosLibrary() {
        const version = "latest"; // Could be made configurable
        const timestamp = Date.now(); // Cache busting for new releases

        const cdnSources = [
          `https://unpkg.com/chronos-timeline-md@${version}/dist/iife-entry.global.js?t=${timestamp}`,
          `https://cdn.jsdelivr.net/npm/chronos-timeline-md@${version}/dist/iife-entry.global.js?t=${timestamp}`,
          `https://unpkg.com/chronos-timeline-md@${version}/dist/iife-entry.global.js`, // No cache bust as fallback
          `https://cdn.jsdelivr.net/npm/chronos-timeline-md@${version}/dist/iife-entry.global.js`,
        ];

        for (let i = 0; i < cdnSources.length; i++) {
          const src = cdnSources[i];
          const isLastAttempt = i === cdnSources.length - 1;

          try {
            console.log(
              `Attempting to load from CDN ${i + 1}/${
                cdnSources.length
              }: ${src}`,
            );
            await loadScript(src, isLastAttempt ? 3 : 1, 1000);

            // Verify the library loaded correctly
            if (window.ChronosTimeline) {
              console.log("Chronos library loaded successfully!");
              return window.ChronosTimeline;
            } else {
              throw new Error(
                "Library loaded but ChronosTimeline not found on window object",
              );
            }
          } catch (error) {
            console.warn(`CDN ${i + 1} failed:`, error.message);

            if (isLastAttempt) {
              throw new Error(
                `All CDN sources failed. Last error: ${error.message}`,
              );
            }
            // Continue to next CDN
          }
        }
      }

      // Update loading status in UI
      function updateLoadingStatus(message, isError = false) {
        const timelineContainer = document.getElementById("timeline-container");
        const statusClass = isError ? "error-message" : "loading";
        timelineContainer.innerHTML = `<div class="${statusClass}">${message}</div>`;
      }

      // Initialize the application (same code for all environments)
      function initializeApp({
        ChronosTimeline,
        parseChronos,
        renderChronos,
        attachChronosStyles,
      }) {
        console.log("Initializing Chronos Timeline...");

        // Display version information if available
        if (ChronosTimeline.version) {
          console.log(`Chronos Timeline version: ${ChronosTimeline.version}`);

          // Update version in header links
          const headerVersion = document.getElementById("header-version");
          if (headerVersion) {
            headerVersion.textContent = `v${ChronosTimeline.version}`;
          }

          // Also add version to page title
          document.title = `Chronos Timeline v${ChronosTimeline.version} - Markdown Playground`;

          // Update the header subtitle to include version
        } else {
          console.warn("ChronosTimeline.version not available");
          // Update fallback version
          const headerVersion = document.getElementById("header-version");
          if (headerVersion) {
            headerVersion.textContent = "version unknown";
            headerVersion.style.background = "rgba(220,53,69,0.1)";
            headerVersion.style.color = "#dc3545";
          }
        }

        // All your existing JavaScript code goes here
        // This is the SAME code for both local dev and GitHub Pages

        // DOM elements
        const markdownInput = document.getElementById("markdown-input");
        const timelineContainer = document.getElementById("timeline-container");
        const localeSelect = document.getElementById("locale-select");
        const roundRangesCheckbox = document.getElementById("round-ranges");
        const useUtcCheckbox = document.getElementById("use-utc");
        const alignmentSelect = document.getElementById("alignment");
        const examplesSelect = document.getElementById("examples-select");
        const snippetsSelect = document.getElementById("snippets-select");
        const exportPngBtn = document.getElementById("export-png-btn");
        const transparentBgCheckbox = document.getElementById(
          "transparent-bg-checkbox",
        );
        const shareLinkBtn = document.getElementById("share-link-btn");
        const exportStatus = document.getElementById("export-status");
        const optionsToggle = document.getElementById("options-toggle");
        const optionsMenu = document.getElementById("options-menu");
        const divider = document.getElementById("divider");
        const inputPanel = document.querySelector(".input-panel");
        const outputPanel = document.querySelector(".output-panel");
        const container = document.querySelector(".container");

        let currentTimeline = null;
        let debounceTimer = null;

        // Resizable divider functionality
        let isResizing = false;
        let isMobile = false;

        function checkMobile() {
          isMobile = window.innerWidth <= 1024;
          return isMobile;
        }

        function initializeResizer() {
          checkMobile();

          // Desktop horizontal divider
          if (divider) {
            divider.addEventListener("mousedown", startResizing);
          }

          // Mobile vertical divider (using input panel's ::after pseudo-element)
          if (inputPanel) {
            inputPanel.addEventListener("mousedown", startMobileResizing);
            inputPanel.addEventListener("touchstart", startMobileResizing, {
              passive: false,
            });
          }

          document.addEventListener("mousemove", handleResize);
          document.addEventListener("touchmove", handleResize, {
            passive: false,
          });
          document.addEventListener("mouseup", stopResizing);
          document.addEventListener("touchend", stopResizing);

          // Update on window resize
          window.addEventListener("resize", () => {
            const wasMobile = isMobile;
            checkMobile();

            // Reset styles when switching between mobile/desktop
            if (wasMobile !== isMobile) {
              inputPanel.style.flexBasis = "";
              outputPanel.style.flexBasis = "";
              inputPanel.style.height = "";
              outputPanel.style.height = "";
              inputPanel.style.flexShrink = "";
              outputPanel.style.flexShrink = "";
            }
          });
        }

        function startResizing(e) {
          if (checkMobile()) return; // Don't handle horizontal resize on mobile

          isResizing = true;
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
          e.preventDefault();
        }

        function startMobileResizing(e) {
          if (!checkMobile()) return; // Only handle on mobile

          // Check if click/touch is near bottom edge (where our pseudo-element divider is)
          const rect = inputPanel.getBoundingClientRect();
          const y = e.type.includes("touch") ? e.touches[0].clientY : e.clientY;
          const bottomEdge = rect.bottom;

          // Only start resizing if within 10px of bottom edge
          if (Math.abs(y - bottomEdge) <= 10) {
            isResizing = true;
            document.body.style.cursor = "row-resize";
            document.body.style.userSelect = "none";
            e.preventDefault();
          }
        }

        function handleResize(e) {
          if (!isResizing) return;

          if (checkMobile()) {
            // Mobile vertical resizing
            const containerRect = container.getBoundingClientRect();
            const y = e.type.includes("touch")
              ? e.touches[0].clientY
              : e.clientY;
            const mouseY = y - containerRect.top;

            // Calculate height percentages
            const totalHeight = containerRect.height;
            const topPercent = Math.max(
              25,
              Math.min(75, (mouseY / totalHeight) * 100),
            );

            // Apply new heights
            inputPanel.style.height = `${topPercent}vh`;
            outputPanel.style.flexGrow = "1";
          } else {
            // Desktop horizontal resizing
            const containerRect = container.getBoundingClientRect();
            const mouseX = e.clientX - containerRect.left;

            // Calculate width percentages
            const totalWidth = containerRect.width - 8; // Subtract divider width
            const leftPercent = Math.max(
              20,
              Math.min(80, (mouseX / containerRect.width) * 100),
            );
            const rightPercent = 100 - leftPercent;

            // Apply the new flex basis
            inputPanel.style.flexBasis = `${leftPercent}%`;
            outputPanel.style.flexBasis = `${rightPercent}%`;

            // Ensure panels don't shrink below flex basis
            inputPanel.style.flexShrink = "0";
            outputPanel.style.flexShrink = "0";
          }
        }

        function stopResizing() {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = "";
            document.body.style.userSelect = "";

            // Trigger timeline redraw after resize
            if (
              currentTimeline &&
              currentTimeline.timeline &&
              typeof currentTimeline.timeline.redraw === "function"
            ) {
              setTimeout(() => {
                currentTimeline.timeline.redraw();
              }, 100);
            }
          }
        }

        // Undo functionality
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        // Build a shareable URL (does NOT modify history)
        function buildShareableUrl() {
          const content = markdownInput.value;
          const locale = localeSelect.value;

          // Start from the current origin+pathname and build query params fresh
          const url = new URL(window.location);
          url.search = "";

          // If content is present, always attempt to compress it for shorter URLs.
          if (content && content.trim()) {
            try {
              const raw = content;
              if (window.LZString && LZString.compressToEncodedURIComponent) {
                const compressed = LZString.compressToEncodedURIComponent(raw);
                // Use compressed value (assume compression is desired)
                url.searchParams.set("content", compressed);
                url.searchParams.set("c", "1");
              } else {
                // LZString not available yet; fall back to raw
                url.searchParams.set("content", raw);
              }
            } catch (e) {
              // On any error, fall back to raw content
              url.searchParams.set("content", content);
            }
          }

          if (locale && locale !== "en") {
            url.searchParams.set("locale", locale);
          }

          return url.toString();
        }

        function loadFromURL() {
          try {
            const queryString = window.location.search;
            if (!queryString) return false;

            const urlParams = new URLSearchParams(queryString);
            const content = urlParams.get("content");
            const locale = urlParams.get("locale");
            const compressedFlag = urlParams.get("c");
            let hasContent = false;

            // Load locale if present
            if (locale && localeSelect) {
              const option = localeSelect.querySelector(
                `option[value="${locale}"]`,
              );
              if (option) {
                localeSelect.value = locale;
              }
            }

            // Load content if present
            if (content) {
              try {
                if (
                  compressedFlag === "1" &&
                  window.LZString &&
                  LZString.decompressFromEncodedURIComponent
                ) {
                  const decompressed =
                    LZString.decompressFromEncodedURIComponent(content);
                  if (decompressed != null) {
                    markdownInput.value = decompressed;
                    hasContent = true;
                  } else {
                    // Fallback to raw if decompression fails
                    markdownInput.value = content;
                    hasContent = true;
                  }
                } else {
                  markdownInput.value = content;
                  hasContent = true;
                }
              } catch (e) {
                console.error("Decompression failed, using raw content:", e);
                markdownInput.value = content;
                hasContent = true;
              }
            }

            return hasContent;
          } catch (error) {
            console.error("Error loading content from URL:", error);
            try {
              const matches =
                window.location.search.match(/[?&]content=([^&]*)/);
              if (matches && matches[1]) {
                const content = decodeURIComponent(
                  matches[1].replace(/\+/g, " "),
                );
                markdownInput.value = content;
                return true;
              }
            } catch (fallbackError) {
              console.error("Fallback URL parsing also failed:", fallbackError);
            }
          }
          return false;
        }

        // History management
        function addToHistory(content) {
          if (historyIndex < history.length - 1) {
            history = history.slice(0, historyIndex + 1);
          }
          history.push(content);

          if (history.length > MAX_HISTORY) {
            history = history.slice(1);
            historyIndex = Math.max(0, historyIndex - 1);
          }

          historyIndex = history.length - 1;
        }

        function undo() {
          if (historyIndex > 0) {
            historyIndex--;
            const previousContent = history[historyIndex];
            markdownInput.value = previousContent;
            // Do not update the browser URL on undo
            renderTimeline();
            updateSyntaxHighlighting();
            return true;
          }
          return false;
        }

        function redo() {
          if (historyIndex < history.length - 1) {
            historyIndex++;
            const nextContent = history[historyIndex];
            markdownInput.value = nextContent;
            // Do not update the browser URL on redo
            renderTimeline();
            updateSyntaxHighlighting();
            return true;
          }
          return false;
        }

        // Examples
        const chronosExamples = [
          {
            title: "Date Formats",
            content: `- [2020] A year
- [2020-02] A month
- [2020-02-28] A day
- [2020-02-28T12] An hour
- [2020-02-28T12:30] A minute
- [2020-02-28T12:30:09] A second`,
          },
          {
            title: "Single Event (-)",
            content: `- [1879-03-14] Einstein born`,
          },
          {
            title: "Date Range",
            content: `- [1991~2001] Time I believed in Santa`,
          },
          {
            title: "Event with Description (|)",
            content: `- [1991~2001] Time I believed in Santa | ended when my brother tried to videotape Santa with a hidden camera

# Hover on a timeline item to see its description`,
          },
          {
            title: "Groups ({})",
            content: `@ [1892-10-08~1941-08-31] {Marina Tsvetaeva} 1892-1941
- [1916] {Marina Tsvetaeva} "–ü–æ–¥—Ä—É–≥–∞"
- [1928] {Marina Tsvetaeva}  "–ü–æ—ç–º–∞ –∫–æ–Ω—Ü–æ–≤"
- [1941] {Marina Tsvetaeva} "–ó–∞–ø–∏—Å–∫–∏ –æ –ø–æ—ç–∑–∏–∏"

@ [1899-08-24~1986-06-14] {Jorge Luis Borges} 1899-1986
- [1944] {Jorge Luis Borges} "Ficciones"
- [1949] {Jorge Luis Borges} "El Aleph"
- [1962] {Jorge Luis Borges} "Labyrinths"`,
          },
          {
            title: "Periods (@)",
            content: `@ [-300~250] Yayoi Period
- [-100] Introduction of rice cultivation
- [-57] Japan's first recorded contact with China`,
          },
          {
            title: "Colored Periods",
            content: `@ [-300~250] #red Yayoi Period
- [-100] Introduction of rice cultivation
- [-57] Japan's first recorded contact with China

@ [250~538] Kofun Period
- [250] Construction of keyhole-shaped kofun burial mounds begins
- [369] Yamato state sends envoys to Korea`,
          },
          {
            title: "Colored Events",
            content: `- [2001~2009] #red Bush
- [2009~2017] #blue Obama
- [2017~2021] #red Trump
- [2021~2025] #blue Biden
@ [2020-03~2023-05] #pink COVID19

# You can also use custom hex-code colors like #dd6689`,
          },
          {
            title: "Points (*)",
            content: `- [2024-02-26~2024-03-10] Tournament
* [2024-02-26] Game 1 | Austin
* [2024-02-28] Game 2 | Los Angeles
* [2024-03-06] Game 3 | Tokyo
* [2024-03-10] Game 4 | Jakarta`,
          },
          {
            title: "Markers (=)",
            content: `= [1440] Invention of the Gutenberg Press

- [1455] Gutenberg Bible Printed
@ [1501~1600] The Spread of Printing
- [1517] Martin Luther's 95 Theses`,
          },
          {
            title: "Order by Start",
            content: `> ORDERBY start

- [2026~2028] Event D
- [2024~2028] Event B
- [2025~2030] #red Event C
- [2020~2030] #red Event A`,
          },
          {
            title: "Order by Color and Start date",
            content: `> ORDERBY color|start

- [2026~2028] Event D
- [2024~2028] Event B
- [2025~2030] #red Event C
- [2020~2030] #red Event A`,
          },
          {
            title: "Default View Range",
            content: `> DEFAULTVIEW -3000|3000
# Offset the default centered view with custom start|end dates

- [2024] AGI`,
          },
          {
            title: "Don't stack items",
            content: `> NOSTACK
# Note: NOSTACK is all or nothing... overlapping items will override eachother

- [2019~2021] {Group A} baz
- [2021~2022] #red {Group A}  foo
- [2021~2022] {Group B} bar
- [2022~2025] #red {Group B} bam`,
          },
          {
            title: "Advanced: Cold War Timeline",
            content: `- [1945-07-17] {Europe} Potsdam Conference | where post-WWII Europe is divided
- [1947-03-12] {USA} Truman Doctrine | committing the U.S. to containing communism
- [1948-06-24~1949-05-12] {Europe} Berlin Blockade | and Airlift in response to Soviet actions in Berlin
- [1949-04-04] {Europe} Formation of NATO

@ [1957~1969] #cyan {USSR} Space Race
@ [1957~1969] #cyan {USA} Space Race
- [1950-06-25~1953-07-27] {Asia} Korean War | between North and South Korea
- [1955-05-14] {USSR} Warsaw Pact | in response to NATO
- [1957-10-04] #cyan {USSR} Sputnik launched | initiating the Space Race
- [1961-04-17] {Cuba} Bay of Pigs Invasion | in Cuba

- [1962-10-16] {Cuba} Cuban Missile Crisis | a peak confrontation between the U.S. and USSR
- [1963-08-05] {Global} Partial Nuclear Test Ban Treaty signed
- [1969-07-20] #cyan {USA} Apollo 11 Moon landing | U.S. wins the Space Race
- [1972-05-26] {Global} SALT I signed | first Strategic Arms Limitation Treaty

- [1979-12-24~1989-02-15] {USSR} Soviet-Afghan War | straining Soviet resources
- [1983-03-23] {USA} Reagan announces the Strategic Defense Initiative (SDI)
- [1986-04-26] {USSR} Chernobyl nuclear disaster
- [1987-12-08] {Global} INF Treaty | signed, eliminating intermediate-range nuclear missiles

- [1989-11-09] {Europe} Fall of the Berlin Wall | symbolizing the end of Cold War tensions
- [1991-07-31] {Global} START I Treaty signed | further arms reduction
- [1991-12-26] {USSR} Dissolution of the Soviet Union | officially ending the Cold War

= [1991-12-26] End of the Cold War`,
          },
        ];

        // Chronos snippets for quick insertion at cursor
        const chronosSnippets = [
          // Basic Elements
          {
            category: "Basic Elements",
            items: [
              {
                title: "Event (single date)",
                content: "- [2024] Event name",
              },
              {
                title: "Event (date range)",
                content: "- [2024~2025] Event name",
              },
              {
                title: "Event with description",
                content: "- [2024] Event name | Description here",
              },
              {
                title: "Event with color",
                content: "- [2024] #red Event name",
              },
              {
                title: "Event with group",
                content: "- [2024] {Group Name} Event name",
              },
              {
                title: "Period",
                content: "@ [2024~2025] Period name",
              },
              {
                title: "Period with color",
                content: "@ [2024~2025] #blue Period name",
              },
              {
                title: "Point",
                content: "* [2024] Point name",
              },
              {
                title: "Marker",
                content: "= [2024] Marker name",
              },
              {
                title: "Comment",
                content: "# This is a comment",
              },
            ],
          },
          // Flags
          {
            category: "Flags (Options)",
            items: [
              {
                title: "Order by start date",
                content: "> ORDERBY start",
              },
              {
                title: "Order by start (descending)",
                content: "> ORDERBY -start",
              },
              {
                title: "Order by color and start",
                content: "> ORDERBY color|start",
              },
              {
                title: "Default view range",
                content: "> DEFAULTVIEW 2020|2030",
              },
              {
                title: "Hide today marker",
                content: "> NOTODAY",
              },
              {
                title: "Don't stack items",
                content: "> NOSTACK",
              },
              {
                title: "Set timeline height",
                content: "> HEIGHT 400",
              },
            ],
          },
        ];

        function populateSnippetsDropdown() {
          snippetsSelect.innerHTML =
            '<option value="">Insert Snippet...</option>';

          chronosSnippets.forEach((category) => {
            // Add category header
            const categoryHeader = document.createElement("optgroup");
            categoryHeader.label = category.category;
            snippetsSelect.appendChild(categoryHeader);

            // Add items in this category
            category.items.forEach((snippet, index) => {
              const option = document.createElement("option");
              option.value = `${category.category}|${index}`;
              option.textContent = snippet.title;
              categoryHeader.appendChild(option);
            });
          });
        }

        function insertSnippetAtCursor() {
          const selectedValue = snippetsSelect.value;
          if (selectedValue === "") return;

          const [categoryName, itemIndex] = selectedValue.split("|");
          const category = chronosSnippets.find(
            (cat) => cat.category === categoryName,
          );
          if (!category) return;

          const snippet = category.items[parseInt(itemIndex)];
          if (!snippet) return;

          // Get cursor position
          const cursorPosition = markdownInput.selectionStart;
          const textBefore = markdownInput.value.substring(0, cursorPosition);
          const textAfter = markdownInput.value.substring(
            markdownInput.selectionEnd,
          );

          // Check if we need to add newlines
          let insertText = snippet.content;

          // Add newline before if not at start and previous char isn't newline
          if (
            cursorPosition > 0 &&
            textBefore.charAt(textBefore.length - 1) !== "\n"
          ) {
            insertText = "\n" + insertText;
          }

          // Add newline after if there's more text and next char isn't newline
          if (textAfter.length > 0 && textAfter.charAt(0) !== "\n") {
            insertText = insertText + "\n";
          }

          // Add to history before making changes
          addToHistory(markdownInput.value);

          // Insert the snippet
          markdownInput.value = textBefore + insertText + textAfter;

          // Set cursor position after inserted text
          const newCursorPosition = cursorPosition + insertText.length;
          markdownInput.focus();
          markdownInput.setSelectionRange(newCursorPosition, newCursorPosition);

          // Reset dropdown. Do not update the browser URL here; user can click Share to generate a URL snapshot.
          snippetsSelect.value = "";
          renderTimeline();
          updateSyntaxHighlighting();
        }

        function populateExamplesDropdown() {
          examplesSelect.innerHTML =
            '<option value="">Show Example...</option>';
          chronosExamples.forEach((example, index) => {
            const option = document.createElement("option");
            option.value = index;
            option.textContent = example.title;
            examplesSelect.appendChild(option);
          });
        }

        function insertExample() {
          const selectedIndex = examplesSelect.value;
          if (selectedIndex === "") return;

          const example = chronosExamples[selectedIndex];
          if (example) {
            addToHistory(markdownInput.value);
            markdownInput.value = example.content;
            // Do not update the browser URL when inserting examples; user can click Share to generate a URL.
            renderTimeline();
            updateSyntaxHighlighting();
          }
          examplesSelect.value = "";
        }

        function toggleOptionsMenu() {
          const isVisible = optionsMenu.style.display !== "none";

          if (isVisible) {
            optionsMenu.style.display = "none";
            optionsToggle.classList.remove("expanded");
          } else {
            optionsMenu.style.display = "flex";
            optionsToggle.classList.add("expanded");
          }
        }

        function renderTimeline() {
          const markdownContent = markdownInput.value.trim();

          if (!markdownContent) {
            timelineContainer.innerHTML =
              '<div class="loading">Enter markdown content to see the timeline. See <a href="https://github.com/clairefro/chronos-timeline-md/blob/main/CHRONOS_SYNTAX_GUIDE.md" target="_blank" rel="noopener noreferrer">docs</a>for syntax.</div>';
            return;
          }

          try {
            if (currentTimeline) {
              try {
                if (
                  currentTimeline.timeline &&
                  typeof currentTimeline.timeline.destroy === "function"
                ) {
                  currentTimeline.timeline.destroy();
                }
              } catch (e) {
                console.warn("Error destroying previous timeline:", e);
              }
              currentTimeline = null;
            }

            timelineContainer.innerHTML = "";

            // Create timeline using new constructor API
            const timeline = new ChronosTimeline({
              container: timelineContainer,
              settings: {
                selectedLocale: localeSelect.value,
                align: alignmentSelect.value,
                clickToUse: false,
                roundRanges: roundRangesCheckbox.checked,
                useUtc: useUtcCheckbox.checked,
                useAI: false,
              },
              callbacks: {
                setTooltip: (el, text) => {
                  el.setAttribute("title", text);
                },
              },
            });

            // Render the timeline and store reference
            timeline.render(markdownContent);

            // Create compatibility structure for export functionality
            currentTimeline = {
              timeline,
              parsed: {
                items: timeline.items || [],
              },
            };

            // Check if there are parse errors first
            const hasErrors = timelineContainer.querySelector(
              ".chronos-error-message-container",
            );

            if (hasErrors) {
              // Parse errors are already displayed by ChronosTimeline
              exportPngBtn.disabled = true;
            } else if (currentTimeline.parsed.items.length === 0) {
              timelineContainer.innerHTML =
                '<div class="loading">No timeline items found. Try adding dates in your markdown</div>';
              exportPngBtn.disabled = true;
            } else {
              exportPngBtn.disabled = false;
            }
          } catch (error) {
            console.error("Timeline rendering error:", error);
            timelineContainer.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            exportPngBtn.disabled = true;
          }
        }

        function debouncedURLUpdate() {
          clearTimeout(debounceTimer);
          // Do not update the browser URL on every input; sharing is explicit.
          // Update syntax highlighting immediately for instant feedback
          updateSyntaxHighlighting();
          // Debounce the timeline rendering to avoid performance issues
          debounceTimer = setTimeout(() => {
            renderTimeline();
          }, 300);
        }

        // Keyboard shortcuts
        function handleKeyboardShortcuts(event) {
          // Only handle shortcuts when textarea is focused
          if (document.activeElement !== markdownInput) {
            return;
          }

          if (
            (event.ctrlKey || event.metaKey) &&
            event.key === "z" &&
            !event.shiftKey
          ) {
            event.preventDefault();
            undo();
          } else if (
            (event.ctrlKey || event.metaKey) &&
            event.key === "z" &&
            event.shiftKey
          ) {
            event.preventDefault();
            redo();
          } else if ((event.ctrlKey || event.metaKey) && event.key === "y") {
            event.preventDefault();
            redo();
          }
        }

        // Track changes for history
        let lastContent = "";
        let changeTimer = null;

        function trackContentChanges() {
          const currentContent = markdownInput.value;
          if (
            currentContent !== lastContent &&
            currentContent !== (history[historyIndex] || "")
          ) {
            clearTimeout(changeTimer);
            changeTimer = setTimeout(() => {
              addToHistory(currentContent);
              lastContent = currentContent;
            }, 1000);
          }
        }

        // Handle locale changes
        function handleLocaleChange() {
          // Locale change should not immediately modify the browser URL.
          renderTimeline();
        }

        // PNG Export functionality
        function exportToPNG() {
          if (!currentTimeline || !currentTimeline.timeline) {
            exportStatus.textContent = "No timeline to export";
            return;
          }

          try {
            exportStatus.textContent = "Generating PNG...";
            exportPngBtn.disabled = true;

            // Create a canvas from the timeline container
            import("https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.esm.js")
              .then(({ default: html2canvas }) => {
                const timelineElement =
                  timelineContainer.querySelector(".vis-timeline");
                if (!timelineElement) {
                  throw new Error("Timeline element not found");
                }

                // Determine background based on user preference and theme
                const useTransparentBg = transparentBgCheckbox.checked;
                const isDarkMode =
                  document.body.getAttribute("data-theme") === "dark";

                let backgroundColor = null; // Default to transparent
                if (!useTransparentBg) {
                  // User wants solid background
                  backgroundColor = isDarkMode ? null : "#ffffff";
                }

                return html2canvas(timelineElement, {
                  backgroundColor: backgroundColor,
                  scale: 2, // Higher resolution
                  useCORS: true,
                  allowTaint: true,
                });
              })
              .then((canvas) => {
                // Create download link
                const link = document.createElement("a");
                link.download = `chronos-timeline-${
                  new Date().toISOString().split("T")[0]
                }.png`;
                link.href = canvas.toDataURL("image/png");

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                exportStatus.textContent = "PNG exported successfully!";
                setTimeout(() => {
                  exportStatus.textContent = "";
                }, 3000);
              })
              .catch((error) => {
                console.error("PNG export failed:", error);
                exportStatus.textContent = "Export failed. Try again.";
                setTimeout(() => {
                  exportStatus.textContent = "";
                }, 3000);
              })
              .finally(() => {
                exportPngBtn.disabled = false;
              });
          } catch (error) {
            console.error("PNG export error:", error);
            exportStatus.textContent = "Export failed. Try again.";
            exportPngBtn.disabled = false;
            setTimeout(() => {
              exportStatus.textContent = "";
            }, 3000);
          }
        }

        // Share Link functionality
        function shareLink() {
          try {
            // Build a snapshot shareable URL (does not modify current history)
            const currentUrl = buildShareableUrl();

            // Try to use the Clipboard API if available
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard
                .writeText(currentUrl)
                .then(() => {
                  exportStatus.textContent = "Link copied to clipboard!";
                  setTimeout(() => {
                    exportStatus.textContent = "";
                  }, 3000);
                })
                .catch((error) => {
                  console.error("Clipboard write failed:", error);
                  fallbackCopyToClipboard(currentUrl);
                });
            } else {
              // Fallback for older browsers
              fallbackCopyToClipboard(currentUrl);
            }
          } catch (error) {
            console.error("Share link error:", error);
            exportStatus.textContent = "Failed to copy link";
            setTimeout(() => {
              exportStatus.textContent = "";
            }, 3000);
          }
        }

        // Fallback clipboard function for older browsers
        function fallbackCopyToClipboard(text) {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.left = "-999999px";
          textArea.style.top = "-999999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();

          try {
            document.execCommand("copy");
            exportStatus.textContent = "Link copied to clipboard!";
            setTimeout(() => {
              exportStatus.textContent = "";
            }, 3000);
          } catch (error) {
            console.error("Fallback copy failed:", error);
            exportStatus.textContent = "Copy failed. Please copy URL manually.";
            setTimeout(() => {
              exportStatus.textContent = "";
            }, 5000);
          } finally {
            document.body.removeChild(textArea);
          }
        }

        // Event listeners
        markdownInput.addEventListener("input", () => {
          debouncedURLUpdate();
          trackContentChanges();
        });
        markdownInput.addEventListener("scroll", syncScroll);
        localeSelect.addEventListener("change", handleLocaleChange);
        roundRangesCheckbox.addEventListener("change", renderTimeline);
        useUtcCheckbox.addEventListener("change", renderTimeline);
        alignmentSelect.addEventListener("change", renderTimeline);
        examplesSelect.addEventListener("change", insertExample);
        snippetsSelect.addEventListener("change", insertSnippetAtCursor);
        optionsToggle.addEventListener("click", toggleOptionsMenu);
        exportPngBtn.addEventListener("click", exportToPNG);
        shareLinkBtn.addEventListener("click", shareLink);
        document.addEventListener("keydown", handleKeyboardShortcuts);

        // Initialize
        initializeResizer();
        populateExamplesDropdown();
        populateSnippetsDropdown();
        const hasURLContent = loadFromURL();
        if (!hasURLContent) {
          // Use current date for "You are here" default content
          const today = new Date().toISOString().split("T")[0];
          markdownInput.value = `- [2000~4160] Age of Aquarius
* [${today}] You are here`;
        }
        addToHistory(markdownInput.value);
        lastContent = markdownInput.value;
        renderTimeline();
        updateSyntaxHighlighting();

        // Handle window resize
        window.addEventListener("resize", () => {
          if (
            currentTimeline &&
            currentTimeline.timeline &&
            typeof currentTimeline.timeline.redraw === "function"
          ) {
            currentTimeline.timeline.redraw();
          }
        });
      }

      // Start the application
      loadChronos();
    </script>

    <!-- LZ-String for client-side compression of shared content -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

    <!-- Goatcounter-->
    <script
      data-goatcounter="https://clairefro.goatcounter.com/count"
      async
      src="//gc.zgo.at/count.js"
    ></script>
  </body>
</html>
